import { __decorate } from "tslib";
import { Injectable } from '@angular/core';
import { combineLatest, of } from 'rxjs';
import { filter, map, switchMap, tap, debounceTime } from 'rxjs/operators';
import { Address, CheckoutDeliveryService, UserAddressService, UserPaymentService, PaymentDetails, DeliveryMode, CheckoutPaymentService, LoaderState, } from '@spartacus/core';
import { CheckoutConfigService } from './checkout-config.service';
import { CheckoutDetailsService } from './checkout-details.service';
import * as i0 from "@angular/core";
import * as i1 from "@spartacus/core";
import * as i2 from "./checkout-details.service";
import * as i3 from "./checkout-config.service";
let ExpressCheckoutService = class ExpressCheckoutService {
    constructor(userAddressService, userPaymentService, checkoutDeliveryService, checkoutPaymentService, checkoutDetailsService, checkoutConfigService) {
        this.userAddressService = userAddressService;
        this.userPaymentService = userPaymentService;
        this.checkoutDeliveryService = checkoutDeliveryService;
        this.checkoutPaymentService = checkoutPaymentService;
        this.checkoutDetailsService = checkoutDetailsService;
        this.checkoutConfigService = checkoutConfigService;
        this.setShippingAddress();
        this.setDeliveryMode();
        this.setPaymentMethod();
    }
    setShippingAddress() {
        this.shippingAddressSet$ = combineLatest([
            this.userAddressService.getAddresses(),
            this.userAddressService.getAddressesLoadedSuccess(),
            this.checkoutDeliveryService.getSetDeliveryAddressProcess(),
        ]).pipe(debounceTime(0), tap(([, addressesLoadedSuccess]) => {
            if (!addressesLoadedSuccess) {
                this.userAddressService.loadAddresses();
            }
        }), filter(([, addressesLoadedSuccess]) => addressesLoadedSuccess), switchMap(([addresses, , setDeliveryAddressProcess]) => {
            const defaultAddress = addresses.find((address) => address.defaultAddress) || addresses[0];
            if (defaultAddress && Object.keys(defaultAddress).length) {
                if (!(setDeliveryAddressProcess.success ||
                    setDeliveryAddressProcess.error ||
                    setDeliveryAddressProcess.loading)) {
                    this.checkoutDeliveryService.setDeliveryAddress(defaultAddress);
                }
                return of(setDeliveryAddressProcess).pipe(filter((setDeliveryAddressProcessState) => {
                    return ((setDeliveryAddressProcessState.success ||
                        setDeliveryAddressProcessState.error) &&
                        !setDeliveryAddressProcessState.loading);
                }), switchMap((setDeliveryAddressProcessState) => {
                    if (setDeliveryAddressProcessState.success) {
                        return this.checkoutDetailsService.getDeliveryAddress();
                    }
                    return of(false);
                }), map((data) => Boolean(data && Object.keys(data).length)));
            }
            return of(false);
        }));
    }
    setPaymentMethod() {
        this.paymentMethodSet$ = combineLatest([
            this.userPaymentService.getPaymentMethods(),
            this.userPaymentService.getPaymentMethodsLoadedSuccess(),
            this.checkoutPaymentService.getSetPaymentDetailsResultProcess(),
        ]).pipe(debounceTime(0), tap(([, paymentMethodsLoadedSuccess]) => {
            if (!paymentMethodsLoadedSuccess) {
                this.userPaymentService.loadPaymentMethods();
            }
        }), filter(([, success]) => success), switchMap(([payments, , setPaymentDetailsProcess]) => {
            const defaultPayment = payments.find((address) => address.defaultPayment) || payments[0];
            if (defaultPayment && Object.keys(defaultPayment).length) {
                if (!(setPaymentDetailsProcess.success ||
                    setPaymentDetailsProcess.error ||
                    setPaymentDetailsProcess.loading)) {
                    this.checkoutPaymentService.setPaymentDetails(defaultPayment);
                }
                return of(setPaymentDetailsProcess).pipe(filter((setPaymentDetailsProcessState) => {
                    return ((setPaymentDetailsProcessState.success ||
                        setPaymentDetailsProcessState.error) &&
                        !setPaymentDetailsProcessState.loading);
                }), switchMap((setPaymentDetailsProcessState) => {
                    if (setPaymentDetailsProcessState.success) {
                        return this.checkoutDetailsService.getPaymentDetails();
                    }
                    return of(false);
                }), map((data) => Boolean(data && Object.keys(data).length)));
            }
            return of(false);
        }));
    }
    setDeliveryMode() {
        this.deliveryModeSet$ = combineLatest([
            this.shippingAddressSet$,
            this.checkoutDeliveryService.getSupportedDeliveryModes(),
            this.checkoutDeliveryService.getSetDeliveryModeProcess(),
            this.checkoutDeliveryService.getLoadSupportedDeliveryModeProcess(),
        ]).pipe(debounceTime(0), switchMap(([addressSet, supportedDeliveryModes, setDeliveryModeStatusFlag, loadSupportedDeliveryModeStatus,]) => {
            if (addressSet) {
                return of([
                    supportedDeliveryModes,
                    setDeliveryModeStatusFlag,
                    loadSupportedDeliveryModeStatus,
                ]).pipe(filter(([, , supportedDeliveryModeStatus]) => supportedDeliveryModeStatus.success), switchMap(([deliveryModes, setDeliveryModeStatus, ,]) => {
                    if (Boolean(deliveryModes.length)) {
                        const preferredDeliveryMode = this.checkoutConfigService.getPreferredDeliveryMode(deliveryModes);
                        return of([
                            preferredDeliveryMode,
                            setDeliveryModeStatus,
                        ]).pipe(tap(([deliveryMode, deliveryModeLoadingStatus]) => {
                            if (deliveryMode &&
                                !(deliveryModeLoadingStatus.success ||
                                    deliveryModeLoadingStatus.error ||
                                    deliveryModeLoadingStatus.loading)) {
                                this.checkoutDeliveryService.setDeliveryMode(deliveryMode);
                            }
                        }), filter(([, deliveryModeLoadingStatus]) => {
                            return ((deliveryModeLoadingStatus.success ||
                                deliveryModeLoadingStatus.error) &&
                                !deliveryModeLoadingStatus.loading);
                        }), switchMap(([, deliveryModeLoadingStatus]) => {
                            if (deliveryModeLoadingStatus.success) {
                                return this.checkoutDetailsService.getSelectedDeliveryModeCode();
                            }
                            return of(false);
                        }), map((data) => Boolean(data)));
                    }
                    return of(false);
                }));
            }
            else {
                return of(false);
            }
        }));
    }
    resetCheckoutProcesses() {
        this.checkoutDeliveryService.resetSetDeliveryAddressProcess();
        this.checkoutPaymentService.resetSetPaymentDetailsProcess();
        this.checkoutDeliveryService.resetSetDeliveryModeProcess();
    }
    trySetDefaultCheckoutDetails() {
        this.resetCheckoutProcesses();
        return combineLatest([this.deliveryModeSet$, this.paymentMethodSet$]).pipe(map(([deliveryModeSet, paymentMethodSet]) => Boolean(deliveryModeSet && paymentMethodSet)));
    }
};
ExpressCheckoutService.ctorParameters = () => [
    { type: UserAddressService },
    { type: UserPaymentService },
    { type: CheckoutDeliveryService },
    { type: CheckoutPaymentService },
    { type: CheckoutDetailsService },
    { type: CheckoutConfigService }
];
ExpressCheckoutService.ɵprov = i0.ɵɵdefineInjectable({ factory: function ExpressCheckoutService_Factory() { return new ExpressCheckoutService(i0.ɵɵinject(i1.UserAddressService), i0.ɵɵinject(i1.UserPaymentService), i0.ɵɵinject(i1.CheckoutDeliveryService), i0.ɵɵinject(i1.CheckoutPaymentService), i0.ɵɵinject(i2.CheckoutDetailsService), i0.ɵɵinject(i3.CheckoutConfigService)); }, token: ExpressCheckoutService, providedIn: "root" });
ExpressCheckoutService = __decorate([
    Injectable({
        providedIn: 'root',
    })
], ExpressCheckoutService);
export { ExpressCheckoutService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwcmVzcy1jaGVja291dC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHNwYXJ0YWN1cy9zdG9yZWZyb250LyIsInNvdXJjZXMiOlsiY21zLWNvbXBvbmVudHMvY2hlY2tvdXQvc2VydmljZXMvZXhwcmVzcy1jaGVja291dC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxhQUFhLEVBQUUsRUFBRSxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQ3JELE9BQU8sRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsWUFBWSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFM0UsT0FBTyxFQUNMLE9BQU8sRUFDUCx1QkFBdUIsRUFDdkIsa0JBQWtCLEVBQ2xCLGtCQUFrQixFQUNsQixjQUFjLEVBQ2QsWUFBWSxFQUNaLHNCQUFzQixFQUN0QixXQUFXLEdBQ1osTUFBTSxpQkFBaUIsQ0FBQztBQUN6QixPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUNsRSxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQzs7Ozs7QUFLcEUsSUFBYSxzQkFBc0IsR0FBbkMsTUFBYSxzQkFBc0I7SUFLakMsWUFDWSxrQkFBc0MsRUFDdEMsa0JBQXNDLEVBQ3RDLHVCQUFnRCxFQUNoRCxzQkFBOEMsRUFDOUMsc0JBQThDLEVBQzlDLHFCQUE0QztRQUw1Qyx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBQ3RDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7UUFDdEMsNEJBQXVCLEdBQXZCLHVCQUF1QixDQUF5QjtRQUNoRCwyQkFBc0IsR0FBdEIsc0JBQXNCLENBQXdCO1FBQzlDLDJCQUFzQixHQUF0QixzQkFBc0IsQ0FBd0I7UUFDOUMsMEJBQXFCLEdBQXJCLHFCQUFxQixDQUF1QjtRQUV0RCxJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztRQUMxQixJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7UUFDdkIsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7SUFDMUIsQ0FBQztJQUVTLGtCQUFrQjtRQUMxQixJQUFJLENBQUMsbUJBQW1CLEdBQUcsYUFBYSxDQUFDO1lBQ3ZDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxZQUFZLEVBQUU7WUFDdEMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLHlCQUF5QixFQUFFO1lBQ25ELElBQUksQ0FBQyx1QkFBdUIsQ0FBQyw0QkFBNEIsRUFBRTtTQUM1RCxDQUFDLENBQUMsSUFBSSxDQUNMLFlBQVksQ0FBQyxDQUFDLENBQUMsRUFDZixHQUFHLENBQ0QsQ0FBQyxDQUFDLEVBQUUsc0JBQXNCLENBSXpCLEVBQUUsRUFBRTtZQUNILElBQUksQ0FBQyxzQkFBc0IsRUFBRTtnQkFDM0IsSUFBSSxDQUFDLGtCQUFrQixDQUFDLGFBQWEsRUFBRSxDQUFDO2FBQ3pDO1FBQ0gsQ0FBQyxDQUNGLEVBQ0QsTUFBTSxDQUNKLENBQUMsQ0FBQyxFQUFFLHNCQUFzQixDQUEwQyxFQUFFLEVBQUUsQ0FDdEUsc0JBQXNCLENBQ3pCLEVBQ0QsU0FBUyxDQUNQLENBQUMsQ0FBQyxTQUFTLEVBQUUsQUFBRCxFQUFHLHlCQUF5QixDQUl2QyxFQUFFLEVBQUU7WUFDSCxNQUFNLGNBQWMsR0FDbEIsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxJQUFJLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN0RSxJQUFJLGNBQWMsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLE1BQU0sRUFBRTtnQkFDeEQsSUFDRSxDQUFDLENBQ0MseUJBQXlCLENBQUMsT0FBTztvQkFDakMseUJBQXlCLENBQUMsS0FBSztvQkFDL0IseUJBQXlCLENBQUMsT0FBTyxDQUNsQyxFQUNEO29CQUNBLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxrQkFBa0IsQ0FBQyxjQUFjLENBQUMsQ0FBQztpQkFDakU7Z0JBQ0QsT0FBTyxFQUFFLENBQUMseUJBQXlCLENBQUMsQ0FBQyxJQUFJLENBQ3ZDLE1BQU0sQ0FBQyxDQUFDLDhCQUFpRCxFQUFFLEVBQUU7b0JBQzNELE9BQU8sQ0FDTCxDQUFDLDhCQUE4QixDQUFDLE9BQU87d0JBQ3JDLDhCQUE4QixDQUFDLEtBQUssQ0FBQzt3QkFDdkMsQ0FBQyw4QkFBOEIsQ0FBQyxPQUFPLENBQ3hDLENBQUM7Z0JBQ0osQ0FBQyxDQUFDLEVBQ0YsU0FBUyxDQUFDLENBQUMsOEJBQWlELEVBQUUsRUFBRTtvQkFDOUQsSUFBSSw4QkFBOEIsQ0FBQyxPQUFPLEVBQUU7d0JBQzFDLE9BQU8sSUFBSSxDQUFDLHNCQUFzQixDQUFDLGtCQUFrQixFQUFFLENBQUM7cUJBQ3pEO29CQUNELE9BQU8sRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUNuQixDQUFDLENBQUMsRUFDRixHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUN6RCxDQUFDO2FBQ0g7WUFDRCxPQUFPLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNuQixDQUFDLENBQ0YsQ0FDRixDQUFDO0lBQ0osQ0FBQztJQUVTLGdCQUFnQjtRQUN4QixJQUFJLENBQUMsaUJBQWlCLEdBQUcsYUFBYSxDQUFDO1lBQ3JDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxpQkFBaUIsRUFBRTtZQUMzQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsOEJBQThCLEVBQUU7WUFDeEQsSUFBSSxDQUFDLHNCQUFzQixDQUFDLGlDQUFpQyxFQUFFO1NBQ2hFLENBQUMsQ0FBQyxJQUFJLENBQ0wsWUFBWSxDQUFDLENBQUMsQ0FBQyxFQUNmLEdBQUcsQ0FDRCxDQUFDLENBQUMsRUFBRSwyQkFBMkIsQ0FJOUIsRUFBRSxFQUFFO1lBQ0gsSUFBSSxDQUFDLDJCQUEyQixFQUFFO2dCQUNoQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsa0JBQWtCLEVBQUUsQ0FBQzthQUM5QztRQUNILENBQUMsQ0FDRixFQUNELE1BQU0sQ0FDSixDQUFDLENBQUMsRUFBRSxPQUFPLENBQWlELEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FDekUsRUFDRCxTQUFTLENBQ1AsQ0FBQyxDQUFDLFFBQVEsRUFBRSxBQUFELEVBQUcsd0JBQXdCLENBSXJDLEVBQUUsRUFBRTtZQUNILE1BQU0sY0FBYyxHQUNsQixRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLElBQUksUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3BFLElBQUksY0FBYyxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsTUFBTSxFQUFFO2dCQUN4RCxJQUNFLENBQUMsQ0FDQyx3QkFBd0IsQ0FBQyxPQUFPO29CQUNoQyx3QkFBd0IsQ0FBQyxLQUFLO29CQUM5Qix3QkFBd0IsQ0FBQyxPQUFPLENBQ2pDLEVBQ0Q7b0JBQ0EsSUFBSSxDQUFDLHNCQUFzQixDQUFDLGlCQUFpQixDQUFDLGNBQWMsQ0FBQyxDQUFDO2lCQUMvRDtnQkFDRCxPQUFPLEVBQUUsQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDLElBQUksQ0FDdEMsTUFBTSxDQUFDLENBQUMsNkJBQWdELEVBQUUsRUFBRTtvQkFDMUQsT0FBTyxDQUNMLENBQUMsNkJBQTZCLENBQUMsT0FBTzt3QkFDcEMsNkJBQTZCLENBQUMsS0FBSyxDQUFDO3dCQUN0QyxDQUFDLDZCQUE2QixDQUFDLE9BQU8sQ0FDdkMsQ0FBQztnQkFDSixDQUFDLENBQUMsRUFDRixTQUFTLENBQUMsQ0FBQyw2QkFBZ0QsRUFBRSxFQUFFO29CQUM3RCxJQUFJLDZCQUE2QixDQUFDLE9BQU8sRUFBRTt3QkFDekMsT0FBTyxJQUFJLENBQUMsc0JBQXNCLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztxQkFDeEQ7b0JBQ0QsT0FBTyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQ25CLENBQUMsQ0FBQyxFQUNGLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLElBQUksSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQ3pELENBQUM7YUFDSDtZQUNELE9BQU8sRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ25CLENBQUMsQ0FDRixDQUNGLENBQUM7SUFDSixDQUFDO0lBRVMsZUFBZTtRQUN2QixJQUFJLENBQUMsZ0JBQWdCLEdBQUcsYUFBYSxDQUFDO1lBQ3BDLElBQUksQ0FBQyxtQkFBbUI7WUFDeEIsSUFBSSxDQUFDLHVCQUF1QixDQUFDLHlCQUF5QixFQUFFO1lBQ3hELElBQUksQ0FBQyx1QkFBdUIsQ0FBQyx5QkFBeUIsRUFBRTtZQUN4RCxJQUFJLENBQUMsdUJBQXVCLENBQUMsbUNBQW1DLEVBQUU7U0FDbkUsQ0FBQyxDQUFDLElBQUksQ0FDTCxZQUFZLENBQUMsQ0FBQyxDQUFDLEVBQ2YsU0FBUyxDQUNQLENBQUMsQ0FDQyxVQUFVLEVBQ1Ysc0JBQXNCLEVBQ3RCLHlCQUF5QixFQUN6QiwrQkFBK0IsRUFDaUMsRUFBRSxFQUFFO1lBQ3BFLElBQUksVUFBVSxFQUFFO2dCQUNkLE9BQU8sRUFBRSxDQUFDO29CQUNSLHNCQUFzQjtvQkFDdEIseUJBQXlCO29CQUN6QiwrQkFBK0I7aUJBQ2hDLENBQUMsQ0FBQyxJQUFJLENBQ0wsTUFBTSxDQUNKLENBQUMsQ0FBQyxFQUFFLEFBQUQsRUFBRywyQkFBMkIsQ0FJaEMsRUFBRSxFQUFFLENBQUMsMkJBQTJCLENBQUMsT0FBTyxDQUMxQyxFQUNELFNBQVMsQ0FDUCxDQUFDLENBQUMsYUFBYSxFQUFFLHFCQUFxQixFQUFFLEFBQUQsRUFJdEMsRUFBRSxFQUFFO29CQUNILElBQUksT0FBTyxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsRUFBRTt3QkFDakMsTUFBTSxxQkFBcUIsR0FBRyxJQUFJLENBQUMscUJBQXFCLENBQUMsd0JBQXdCLENBQy9FLGFBQWEsQ0FDZCxDQUFDO3dCQUNGLE9BQU8sRUFBRSxDQUFDOzRCQUNSLHFCQUFxQjs0QkFDckIscUJBQXFCO3lCQUN0QixDQUFDLENBQUMsSUFBSSxDQUNMLEdBQUcsQ0FDRCxDQUFDLENBQUMsWUFBWSxFQUFFLHlCQUF5QixDQUd4QyxFQUFFLEVBQUU7NEJBQ0gsSUFDRSxZQUFZO2dDQUNaLENBQUMsQ0FDQyx5QkFBeUIsQ0FBQyxPQUFPO29DQUNqQyx5QkFBeUIsQ0FBQyxLQUFLO29DQUMvQix5QkFBeUIsQ0FBQyxPQUFPLENBQ2xDLEVBQ0Q7Z0NBQ0EsSUFBSSxDQUFDLHVCQUF1QixDQUFDLGVBQWUsQ0FDMUMsWUFBWSxDQUNiLENBQUM7NkJBQ0g7d0JBQ0gsQ0FBQyxDQUNGLEVBQ0QsTUFBTSxDQUNKLENBQUMsQ0FBQyxFQUFFLHlCQUF5QixDQUc1QixFQUFFLEVBQUU7NEJBQ0gsT0FBTyxDQUNMLENBQUMseUJBQXlCLENBQUMsT0FBTztnQ0FDaEMseUJBQXlCLENBQUMsS0FBSyxDQUFDO2dDQUNsQyxDQUFDLHlCQUF5QixDQUFDLE9BQU8sQ0FDbkMsQ0FBQzt3QkFDSixDQUFDLENBQ0YsRUFDRCxTQUFTLENBQ1AsQ0FBQyxDQUFDLEVBQUUseUJBQXlCLENBRzVCLEVBQUUsRUFBRTs0QkFDSCxJQUFJLHlCQUF5QixDQUFDLE9BQU8sRUFBRTtnQ0FDckMsT0FBTyxJQUFJLENBQUMsc0JBQXNCLENBQUMsMkJBQTJCLEVBQUUsQ0FBQzs2QkFDbEU7NEJBQ0QsT0FBTyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUM7d0JBQ25CLENBQUMsQ0FDRixFQUNELEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQzdCLENBQUM7cUJBQ0g7b0JBQ0QsT0FBTyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQ25CLENBQUMsQ0FDRixDQUNGLENBQUM7YUFDSDtpQkFBTTtnQkFDTCxPQUFPLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUNsQjtRQUNILENBQUMsQ0FDRixDQUNGLENBQUM7SUFDSixDQUFDO0lBRVMsc0JBQXNCO1FBQzlCLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyw4QkFBOEIsRUFBRSxDQUFDO1FBQzlELElBQUksQ0FBQyxzQkFBc0IsQ0FBQyw2QkFBNkIsRUFBRSxDQUFDO1FBQzVELElBQUksQ0FBQyx1QkFBdUIsQ0FBQywyQkFBMkIsRUFBRSxDQUFDO0lBQzdELENBQUM7SUFFTSw0QkFBNEI7UUFDakMsSUFBSSxDQUFDLHNCQUFzQixFQUFFLENBQUM7UUFDOUIsT0FBTyxhQUFhLENBQUMsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQ3hFLEdBQUcsQ0FBQyxDQUFDLENBQUMsZUFBZSxFQUFFLGdCQUFnQixDQUFDLEVBQUUsRUFBRSxDQUMxQyxPQUFPLENBQUMsZUFBZSxJQUFJLGdCQUFnQixDQUFDLENBQzdDLENBQ0YsQ0FBQztJQUNKLENBQUM7Q0FDRixDQUFBOztZQTFQaUMsa0JBQWtCO1lBQ2xCLGtCQUFrQjtZQUNiLHVCQUF1QjtZQUN4QixzQkFBc0I7WUFDdEIsc0JBQXNCO1lBQ3ZCLHFCQUFxQjs7O0FBWDdDLHNCQUFzQjtJQUhsQyxVQUFVLENBQUM7UUFDVixVQUFVLEVBQUUsTUFBTTtLQUNuQixDQUFDO0dBQ1csc0JBQXNCLENBZ1FsQztTQWhRWSxzQkFBc0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBjb21iaW5lTGF0ZXN0LCBvZiwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZmlsdGVyLCBtYXAsIHN3aXRjaE1hcCwgdGFwLCBkZWJvdW5jZVRpbWUgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7XG4gIEFkZHJlc3MsXG4gIENoZWNrb3V0RGVsaXZlcnlTZXJ2aWNlLFxuICBVc2VyQWRkcmVzc1NlcnZpY2UsXG4gIFVzZXJQYXltZW50U2VydmljZSxcbiAgUGF5bWVudERldGFpbHMsXG4gIERlbGl2ZXJ5TW9kZSxcbiAgQ2hlY2tvdXRQYXltZW50U2VydmljZSxcbiAgTG9hZGVyU3RhdGUsXG59IGZyb20gJ0BzcGFydGFjdXMvY29yZSc7XG5pbXBvcnQgeyBDaGVja291dENvbmZpZ1NlcnZpY2UgfSBmcm9tICcuL2NoZWNrb3V0LWNvbmZpZy5zZXJ2aWNlJztcbmltcG9ydCB7IENoZWNrb3V0RGV0YWlsc1NlcnZpY2UgfSBmcm9tICcuL2NoZWNrb3V0LWRldGFpbHMuc2VydmljZSc7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxufSlcbmV4cG9ydCBjbGFzcyBFeHByZXNzQ2hlY2tvdXRTZXJ2aWNlIHtcbiAgcHJpdmF0ZSBzaGlwcGluZ0FkZHJlc3NTZXQkOiBPYnNlcnZhYmxlPGJvb2xlYW4+O1xuICBwcml2YXRlIGRlbGl2ZXJ5TW9kZVNldCQ6IE9ic2VydmFibGU8Ym9vbGVhbj47XG4gIHByaXZhdGUgcGF5bWVudE1ldGhvZFNldCQ6IE9ic2VydmFibGU8Ym9vbGVhbj47XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJvdGVjdGVkIHVzZXJBZGRyZXNzU2VydmljZTogVXNlckFkZHJlc3NTZXJ2aWNlLFxuICAgIHByb3RlY3RlZCB1c2VyUGF5bWVudFNlcnZpY2U6IFVzZXJQYXltZW50U2VydmljZSxcbiAgICBwcm90ZWN0ZWQgY2hlY2tvdXREZWxpdmVyeVNlcnZpY2U6IENoZWNrb3V0RGVsaXZlcnlTZXJ2aWNlLFxuICAgIHByb3RlY3RlZCBjaGVja291dFBheW1lbnRTZXJ2aWNlOiBDaGVja291dFBheW1lbnRTZXJ2aWNlLFxuICAgIHByb3RlY3RlZCBjaGVja291dERldGFpbHNTZXJ2aWNlOiBDaGVja291dERldGFpbHNTZXJ2aWNlLFxuICAgIHByb3RlY3RlZCBjaGVja291dENvbmZpZ1NlcnZpY2U6IENoZWNrb3V0Q29uZmlnU2VydmljZVxuICApIHtcbiAgICB0aGlzLnNldFNoaXBwaW5nQWRkcmVzcygpO1xuICAgIHRoaXMuc2V0RGVsaXZlcnlNb2RlKCk7XG4gICAgdGhpcy5zZXRQYXltZW50TWV0aG9kKCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgc2V0U2hpcHBpbmdBZGRyZXNzKCkge1xuICAgIHRoaXMuc2hpcHBpbmdBZGRyZXNzU2V0JCA9IGNvbWJpbmVMYXRlc3QoW1xuICAgICAgdGhpcy51c2VyQWRkcmVzc1NlcnZpY2UuZ2V0QWRkcmVzc2VzKCksXG4gICAgICB0aGlzLnVzZXJBZGRyZXNzU2VydmljZS5nZXRBZGRyZXNzZXNMb2FkZWRTdWNjZXNzKCksXG4gICAgICB0aGlzLmNoZWNrb3V0RGVsaXZlcnlTZXJ2aWNlLmdldFNldERlbGl2ZXJ5QWRkcmVzc1Byb2Nlc3MoKSxcbiAgICBdKS5waXBlKFxuICAgICAgZGVib3VuY2VUaW1lKDApLFxuICAgICAgdGFwKFxuICAgICAgICAoWywgYWRkcmVzc2VzTG9hZGVkU3VjY2Vzc106IFtcbiAgICAgICAgICBBZGRyZXNzW10sXG4gICAgICAgICAgYm9vbGVhbixcbiAgICAgICAgICBMb2FkZXJTdGF0ZTx2b2lkPlxuICAgICAgICBdKSA9PiB7XG4gICAgICAgICAgaWYgKCFhZGRyZXNzZXNMb2FkZWRTdWNjZXNzKSB7XG4gICAgICAgICAgICB0aGlzLnVzZXJBZGRyZXNzU2VydmljZS5sb2FkQWRkcmVzc2VzKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICApLFxuICAgICAgZmlsdGVyKFxuICAgICAgICAoWywgYWRkcmVzc2VzTG9hZGVkU3VjY2Vzc106IFtBZGRyZXNzW10sIGJvb2xlYW4sIExvYWRlclN0YXRlPHZvaWQ+XSkgPT5cbiAgICAgICAgICBhZGRyZXNzZXNMb2FkZWRTdWNjZXNzXG4gICAgICApLFxuICAgICAgc3dpdGNoTWFwKFxuICAgICAgICAoW2FkZHJlc3NlcywgLCBzZXREZWxpdmVyeUFkZHJlc3NQcm9jZXNzXTogW1xuICAgICAgICAgIEFkZHJlc3NbXSxcbiAgICAgICAgICBib29sZWFuLFxuICAgICAgICAgIExvYWRlclN0YXRlPHZvaWQ+XG4gICAgICAgIF0pID0+IHtcbiAgICAgICAgICBjb25zdCBkZWZhdWx0QWRkcmVzcyA9XG4gICAgICAgICAgICBhZGRyZXNzZXMuZmluZCgoYWRkcmVzcykgPT4gYWRkcmVzcy5kZWZhdWx0QWRkcmVzcykgfHwgYWRkcmVzc2VzWzBdO1xuICAgICAgICAgIGlmIChkZWZhdWx0QWRkcmVzcyAmJiBPYmplY3Qua2V5cyhkZWZhdWx0QWRkcmVzcykubGVuZ3RoKSB7XG4gICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICEoXG4gICAgICAgICAgICAgICAgc2V0RGVsaXZlcnlBZGRyZXNzUHJvY2Vzcy5zdWNjZXNzIHx8XG4gICAgICAgICAgICAgICAgc2V0RGVsaXZlcnlBZGRyZXNzUHJvY2Vzcy5lcnJvciB8fFxuICAgICAgICAgICAgICAgIHNldERlbGl2ZXJ5QWRkcmVzc1Byb2Nlc3MubG9hZGluZ1xuICAgICAgICAgICAgICApXG4gICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgdGhpcy5jaGVja291dERlbGl2ZXJ5U2VydmljZS5zZXREZWxpdmVyeUFkZHJlc3MoZGVmYXVsdEFkZHJlc3MpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIG9mKHNldERlbGl2ZXJ5QWRkcmVzc1Byb2Nlc3MpLnBpcGUoXG4gICAgICAgICAgICAgIGZpbHRlcigoc2V0RGVsaXZlcnlBZGRyZXNzUHJvY2Vzc1N0YXRlOiBMb2FkZXJTdGF0ZTx2b2lkPikgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAgICAgICAoc2V0RGVsaXZlcnlBZGRyZXNzUHJvY2Vzc1N0YXRlLnN1Y2Nlc3MgfHxcbiAgICAgICAgICAgICAgICAgICAgc2V0RGVsaXZlcnlBZGRyZXNzUHJvY2Vzc1N0YXRlLmVycm9yKSAmJlxuICAgICAgICAgICAgICAgICAgIXNldERlbGl2ZXJ5QWRkcmVzc1Byb2Nlc3NTdGF0ZS5sb2FkaW5nXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgIHN3aXRjaE1hcCgoc2V0RGVsaXZlcnlBZGRyZXNzUHJvY2Vzc1N0YXRlOiBMb2FkZXJTdGF0ZTx2b2lkPikgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChzZXREZWxpdmVyeUFkZHJlc3NQcm9jZXNzU3RhdGUuc3VjY2Vzcykge1xuICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2hlY2tvdXREZXRhaWxzU2VydmljZS5nZXREZWxpdmVyeUFkZHJlc3MoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIG9mKGZhbHNlKTtcbiAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgIG1hcCgoZGF0YSkgPT4gQm9vbGVhbihkYXRhICYmIE9iamVjdC5rZXlzKGRhdGEpLmxlbmd0aCkpXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gb2YoZmFsc2UpO1xuICAgICAgICB9XG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBzZXRQYXltZW50TWV0aG9kKCkge1xuICAgIHRoaXMucGF5bWVudE1ldGhvZFNldCQgPSBjb21iaW5lTGF0ZXN0KFtcbiAgICAgIHRoaXMudXNlclBheW1lbnRTZXJ2aWNlLmdldFBheW1lbnRNZXRob2RzKCksXG4gICAgICB0aGlzLnVzZXJQYXltZW50U2VydmljZS5nZXRQYXltZW50TWV0aG9kc0xvYWRlZFN1Y2Nlc3MoKSxcbiAgICAgIHRoaXMuY2hlY2tvdXRQYXltZW50U2VydmljZS5nZXRTZXRQYXltZW50RGV0YWlsc1Jlc3VsdFByb2Nlc3MoKSxcbiAgICBdKS5waXBlKFxuICAgICAgZGVib3VuY2VUaW1lKDApLFxuICAgICAgdGFwKFxuICAgICAgICAoWywgcGF5bWVudE1ldGhvZHNMb2FkZWRTdWNjZXNzXTogW1xuICAgICAgICAgIFBheW1lbnREZXRhaWxzW10sXG4gICAgICAgICAgYm9vbGVhbixcbiAgICAgICAgICBMb2FkZXJTdGF0ZTx2b2lkPlxuICAgICAgICBdKSA9PiB7XG4gICAgICAgICAgaWYgKCFwYXltZW50TWV0aG9kc0xvYWRlZFN1Y2Nlc3MpIHtcbiAgICAgICAgICAgIHRoaXMudXNlclBheW1lbnRTZXJ2aWNlLmxvYWRQYXltZW50TWV0aG9kcygpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgKSxcbiAgICAgIGZpbHRlcihcbiAgICAgICAgKFssIHN1Y2Nlc3NdOiBbUGF5bWVudERldGFpbHNbXSwgYm9vbGVhbiwgTG9hZGVyU3RhdGU8dm9pZD5dKSA9PiBzdWNjZXNzXG4gICAgICApLFxuICAgICAgc3dpdGNoTWFwKFxuICAgICAgICAoW3BheW1lbnRzLCAsIHNldFBheW1lbnREZXRhaWxzUHJvY2Vzc106IFtcbiAgICAgICAgICBQYXltZW50RGV0YWlsc1tdLFxuICAgICAgICAgIGJvb2xlYW4sXG4gICAgICAgICAgTG9hZGVyU3RhdGU8dm9pZD5cbiAgICAgICAgXSkgPT4ge1xuICAgICAgICAgIGNvbnN0IGRlZmF1bHRQYXltZW50ID1cbiAgICAgICAgICAgIHBheW1lbnRzLmZpbmQoKGFkZHJlc3MpID0+IGFkZHJlc3MuZGVmYXVsdFBheW1lbnQpIHx8IHBheW1lbnRzWzBdO1xuICAgICAgICAgIGlmIChkZWZhdWx0UGF5bWVudCAmJiBPYmplY3Qua2V5cyhkZWZhdWx0UGF5bWVudCkubGVuZ3RoKSB7XG4gICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICEoXG4gICAgICAgICAgICAgICAgc2V0UGF5bWVudERldGFpbHNQcm9jZXNzLnN1Y2Nlc3MgfHxcbiAgICAgICAgICAgICAgICBzZXRQYXltZW50RGV0YWlsc1Byb2Nlc3MuZXJyb3IgfHxcbiAgICAgICAgICAgICAgICBzZXRQYXltZW50RGV0YWlsc1Byb2Nlc3MubG9hZGluZ1xuICAgICAgICAgICAgICApXG4gICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgdGhpcy5jaGVja291dFBheW1lbnRTZXJ2aWNlLnNldFBheW1lbnREZXRhaWxzKGRlZmF1bHRQYXltZW50KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBvZihzZXRQYXltZW50RGV0YWlsc1Byb2Nlc3MpLnBpcGUoXG4gICAgICAgICAgICAgIGZpbHRlcigoc2V0UGF5bWVudERldGFpbHNQcm9jZXNzU3RhdGU6IExvYWRlclN0YXRlPHZvaWQ+KSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICAgIChzZXRQYXltZW50RGV0YWlsc1Byb2Nlc3NTdGF0ZS5zdWNjZXNzIHx8XG4gICAgICAgICAgICAgICAgICAgIHNldFBheW1lbnREZXRhaWxzUHJvY2Vzc1N0YXRlLmVycm9yKSAmJlxuICAgICAgICAgICAgICAgICAgIXNldFBheW1lbnREZXRhaWxzUHJvY2Vzc1N0YXRlLmxvYWRpbmdcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgc3dpdGNoTWFwKChzZXRQYXltZW50RGV0YWlsc1Byb2Nlc3NTdGF0ZTogTG9hZGVyU3RhdGU8dm9pZD4pID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoc2V0UGF5bWVudERldGFpbHNQcm9jZXNzU3RhdGUuc3VjY2Vzcykge1xuICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2hlY2tvdXREZXRhaWxzU2VydmljZS5nZXRQYXltZW50RGV0YWlscygpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gb2YoZmFsc2UpO1xuICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgbWFwKChkYXRhKSA9PiBCb29sZWFuKGRhdGEgJiYgT2JqZWN0LmtleXMoZGF0YSkubGVuZ3RoKSlcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBvZihmYWxzZSk7XG4gICAgICAgIH1cbiAgICAgIClcbiAgICApO1xuICB9XG5cbiAgcHJvdGVjdGVkIHNldERlbGl2ZXJ5TW9kZSgpIHtcbiAgICB0aGlzLmRlbGl2ZXJ5TW9kZVNldCQgPSBjb21iaW5lTGF0ZXN0KFtcbiAgICAgIHRoaXMuc2hpcHBpbmdBZGRyZXNzU2V0JCxcbiAgICAgIHRoaXMuY2hlY2tvdXREZWxpdmVyeVNlcnZpY2UuZ2V0U3VwcG9ydGVkRGVsaXZlcnlNb2RlcygpLFxuICAgICAgdGhpcy5jaGVja291dERlbGl2ZXJ5U2VydmljZS5nZXRTZXREZWxpdmVyeU1vZGVQcm9jZXNzKCksXG4gICAgICB0aGlzLmNoZWNrb3V0RGVsaXZlcnlTZXJ2aWNlLmdldExvYWRTdXBwb3J0ZWREZWxpdmVyeU1vZGVQcm9jZXNzKCksXG4gICAgXSkucGlwZShcbiAgICAgIGRlYm91bmNlVGltZSgwKSxcbiAgICAgIHN3aXRjaE1hcChcbiAgICAgICAgKFtcbiAgICAgICAgICBhZGRyZXNzU2V0LFxuICAgICAgICAgIHN1cHBvcnRlZERlbGl2ZXJ5TW9kZXMsXG4gICAgICAgICAgc2V0RGVsaXZlcnlNb2RlU3RhdHVzRmxhZyxcbiAgICAgICAgICBsb2FkU3VwcG9ydGVkRGVsaXZlcnlNb2RlU3RhdHVzLFxuICAgICAgICBdOiBbYm9vbGVhbiwgRGVsaXZlcnlNb2RlW10sIExvYWRlclN0YXRlPHZvaWQ+LCBMb2FkZXJTdGF0ZTx2b2lkPl0pID0+IHtcbiAgICAgICAgICBpZiAoYWRkcmVzc1NldCkge1xuICAgICAgICAgICAgcmV0dXJuIG9mKFtcbiAgICAgICAgICAgICAgc3VwcG9ydGVkRGVsaXZlcnlNb2RlcyxcbiAgICAgICAgICAgICAgc2V0RGVsaXZlcnlNb2RlU3RhdHVzRmxhZyxcbiAgICAgICAgICAgICAgbG9hZFN1cHBvcnRlZERlbGl2ZXJ5TW9kZVN0YXR1cyxcbiAgICAgICAgICAgIF0pLnBpcGUoXG4gICAgICAgICAgICAgIGZpbHRlcihcbiAgICAgICAgICAgICAgICAoWywgLCBzdXBwb3J0ZWREZWxpdmVyeU1vZGVTdGF0dXNdOiBbXG4gICAgICAgICAgICAgICAgICBEZWxpdmVyeU1vZGVbXSxcbiAgICAgICAgICAgICAgICAgIExvYWRlclN0YXRlPHZvaWQ+LFxuICAgICAgICAgICAgICAgICAgTG9hZGVyU3RhdGU8dm9pZD5cbiAgICAgICAgICAgICAgICBdKSA9PiBzdXBwb3J0ZWREZWxpdmVyeU1vZGVTdGF0dXMuc3VjY2Vzc1xuICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICBzd2l0Y2hNYXAoXG4gICAgICAgICAgICAgICAgKFtkZWxpdmVyeU1vZGVzLCBzZXREZWxpdmVyeU1vZGVTdGF0dXMsICxdOiBbXG4gICAgICAgICAgICAgICAgICBEZWxpdmVyeU1vZGVbXSxcbiAgICAgICAgICAgICAgICAgIExvYWRlclN0YXRlPHZvaWQ+LFxuICAgICAgICAgICAgICAgICAgTG9hZGVyU3RhdGU8dm9pZD5cbiAgICAgICAgICAgICAgICBdKSA9PiB7XG4gICAgICAgICAgICAgICAgICBpZiAoQm9vbGVhbihkZWxpdmVyeU1vZGVzLmxlbmd0aCkpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJlZmVycmVkRGVsaXZlcnlNb2RlID0gdGhpcy5jaGVja291dENvbmZpZ1NlcnZpY2UuZ2V0UHJlZmVycmVkRGVsaXZlcnlNb2RlKFxuICAgICAgICAgICAgICAgICAgICAgIGRlbGl2ZXJ5TW9kZXNcbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9mKFtcbiAgICAgICAgICAgICAgICAgICAgICBwcmVmZXJyZWREZWxpdmVyeU1vZGUsXG4gICAgICAgICAgICAgICAgICAgICAgc2V0RGVsaXZlcnlNb2RlU3RhdHVzLFxuICAgICAgICAgICAgICAgICAgICBdKS5waXBlKFxuICAgICAgICAgICAgICAgICAgICAgIHRhcChcbiAgICAgICAgICAgICAgICAgICAgICAgIChbZGVsaXZlcnlNb2RlLCBkZWxpdmVyeU1vZGVMb2FkaW5nU3RhdHVzXTogW1xuICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgIExvYWRlclN0YXRlPHZvaWQ+XG4gICAgICAgICAgICAgICAgICAgICAgICBdKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxpdmVyeU1vZGUgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAhKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsaXZlcnlNb2RlTG9hZGluZ1N0YXR1cy5zdWNjZXNzIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxpdmVyeU1vZGVMb2FkaW5nU3RhdHVzLmVycm9yIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxpdmVyeU1vZGVMb2FkaW5nU3RhdHVzLmxvYWRpbmdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2hlY2tvdXREZWxpdmVyeVNlcnZpY2Uuc2V0RGVsaXZlcnlNb2RlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsaXZlcnlNb2RlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgICAgICAgZmlsdGVyKFxuICAgICAgICAgICAgICAgICAgICAgICAgKFssIGRlbGl2ZXJ5TW9kZUxvYWRpbmdTdGF0dXNdOiBbXG4gICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgTG9hZGVyU3RhdGU8dm9pZD5cbiAgICAgICAgICAgICAgICAgICAgICAgIF0pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoZGVsaXZlcnlNb2RlTG9hZGluZ1N0YXR1cy5zdWNjZXNzIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxpdmVyeU1vZGVMb2FkaW5nU3RhdHVzLmVycm9yKSAmJlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICFkZWxpdmVyeU1vZGVMb2FkaW5nU3RhdHVzLmxvYWRpbmdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaE1hcChcbiAgICAgICAgICAgICAgICAgICAgICAgIChbLCBkZWxpdmVyeU1vZGVMb2FkaW5nU3RhdHVzXTogW1xuICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgIExvYWRlclN0YXRlPHZvaWQ+XG4gICAgICAgICAgICAgICAgICAgICAgICBdKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkZWxpdmVyeU1vZGVMb2FkaW5nU3RhdHVzLnN1Y2Nlc3MpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jaGVja291dERldGFpbHNTZXJ2aWNlLmdldFNlbGVjdGVkRGVsaXZlcnlNb2RlQ29kZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvZihmYWxzZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgICAgICBtYXAoKGRhdGEpID0+IEJvb2xlYW4oZGF0YSkpXG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICByZXR1cm4gb2YoZmFsc2UpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIG9mKGZhbHNlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIClcbiAgICApO1xuICB9XG5cbiAgcHJvdGVjdGVkIHJlc2V0Q2hlY2tvdXRQcm9jZXNzZXMoKSB7XG4gICAgdGhpcy5jaGVja291dERlbGl2ZXJ5U2VydmljZS5yZXNldFNldERlbGl2ZXJ5QWRkcmVzc1Byb2Nlc3MoKTtcbiAgICB0aGlzLmNoZWNrb3V0UGF5bWVudFNlcnZpY2UucmVzZXRTZXRQYXltZW50RGV0YWlsc1Byb2Nlc3MoKTtcbiAgICB0aGlzLmNoZWNrb3V0RGVsaXZlcnlTZXJ2aWNlLnJlc2V0U2V0RGVsaXZlcnlNb2RlUHJvY2VzcygpO1xuICB9XG5cbiAgcHVibGljIHRyeVNldERlZmF1bHRDaGVja291dERldGFpbHMoKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgdGhpcy5yZXNldENoZWNrb3V0UHJvY2Vzc2VzKCk7XG4gICAgcmV0dXJuIGNvbWJpbmVMYXRlc3QoW3RoaXMuZGVsaXZlcnlNb2RlU2V0JCwgdGhpcy5wYXltZW50TWV0aG9kU2V0JF0pLnBpcGUoXG4gICAgICBtYXAoKFtkZWxpdmVyeU1vZGVTZXQsIHBheW1lbnRNZXRob2RTZXRdKSA9PlxuICAgICAgICBCb29sZWFuKGRlbGl2ZXJ5TW9kZVNldCAmJiBwYXltZW50TWV0aG9kU2V0KVxuICAgICAgKVxuICAgICk7XG4gIH1cbn1cbiJdfQ==